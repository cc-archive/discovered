#!/bin/bash
set +x

# This script installs DiscoverEd, adds some sample data, and runs a test search.
#
# For more information see <http://wiki.creativecommons.org/DiscoverEd_Quickstart>.
# --------------------------------------------------------

# If you change this directory, be sure to update the value of the
# "searcher.dir" property in conf/nutch-site.xml.template
DISCOVER_ED_ROOT=/var/lib/discovered 

TOMCAT_HTTP_PORT=8472
TOMCAT_SERVER_PORT=8006
TOMCAT_REDIRECT_PORT=8444

function die() {
    echo 
    echo "--- Error ---------------"
    numargs=$#
    for ((i=1; i <= numargs; i++)); do
        echo "$1"
        shift
    done
    echo "-------------------------"
    exit 1
}

dependencies="nc ant mysql git wc wget"
failed_dependencies=""
for dep in $dependencies; do
    which $dep > /dev/null || failed_dependencies="$failed_dependencies $dep"
done

# If this has exit code 1, then the port is closed
for port in $TOMCAT_HTTP_PORT $TOMCAT_SERVER_PORT $TOMCAT_REDIRECT_PORT; do
    if nc -z localhost $port; then
        die "To run this quickstart, you'll need to make port $port available. Another process is using that port (most likely something previously launched by this script). You can also change the values of the TOMCAT*PORT variables in the script if you need."
    fi
done

if [ "${failed_dependencies}" ]; then
    die "DiscoverEd requires the following missing dependencies:" "${failed_dependencies}" "You might be able to install this/these with a package manager like apt-get or yum."
fi

stty -echo
read -p "MySQL root password: " MYSQL_ROOT_PASSWORD; echo
stty echo

# Set up a database
echo 'DROP DATABASE IF EXISTS discovered; CREATE DATABASE discovered; GRANT ALL ON discovered.* TO discovered@localhost' | mysql -uroot -p"$MYSQL_ROOT_PASSWORD" || die 'Please edit this script, and change the MYSQL_ROOT_PASSWORD variable to your MySQL root password.'

if [ -z $JAVA_HOME ]; then
    die "To run this script, you'll need to set the environment variable \$JAVA_HOME. This might work:" "   export JAVA_HOME=/usr/lib/jvm/java-6-sun/jre/"
fi

cd /tmp/

# Move the old directory out of the way
if [ -d "$DISCOVER_ED_ROOT" ]; then
    die "Oops, it looks like you already have a directory called $DISCOVER_ED_ROOT. To do a fresh install, move that directory, or remove it, then re-run this script."
fi

sudo mkdir $DISCOVER_ED_ROOT
sudo chown $USER $DISCOVER_ED_ROOT
cd $DISCOVER_ED_ROOT

# Get the code
if [ -n "$1" ]; then
    git clone $1 src
else
    git clone git://gitorious.org/discovered/repo.git src
fi

cd src

# At the moment, master isn't working.
git checkout deploy_script

# Build
ant -q # will take ~30 seconds
ant war -q

# Add a curator
./bin/feeds addcurator "Notre Dame OpenCourseWare" http://ocw.nd.edu/

# Add a feed
./bin/feeds addfeed rss http://ocw.nd.edu/courselist/rss http://ocw.nd.edu/

# Check that all is well.
./bin/feeds listfeeds

# Do an aggregation
./bin/feeds aggregate

mkdir seed

# Create a seed file that Nutch can use when it crawls the web
./bin/feeds seed > seed/urls

echo "The seed file has this many lines:"
wc -l seed/urls

# For testing, let's try using nutch directly
#./bin/nutch crawl seed -dir crawl -depth 1 

./bin/nutch inject $DISCOVER_ED_ROOT/crawl/crawldb seed
./bin/nutch generate $DISCOVER_ED_ROOT/crawl/crawldb $DISCOVER_ED_ROOT/crawl/segments
./bin/nutch fetch $DISCOVER_ED_ROOT/crawl/segments/*
./bin/nutch updatedb $DISCOVER_ED_ROOT/crawl/crawldb $DISCOVER_ED_ROOT/crawl/segments/*
./bin/nutch invertlinks $DISCOVER_ED_ROOT/crawl/linkdb $DISCOVER_ED_ROOT/crawl/segments/*
./bin/nutch index $DISCOVER_ED_ROOT/crawl/indexes $DISCOVER_ED_ROOT/crawl/crawldb $DISCOVER_ED_ROOT/crawl/linkdb $DISCOVER_ED_ROOT/crawl/segments/*

#ant -f dedbuild.xml crawl

echo "We expect to see at least one hit for the string 'crime'"

# Query the search engine
./bin/nutch org.apache.nutch.searcher.NutchBean crime

cd $DISCOVER_ED_ROOT

# Get tomcat, install it into this directory
wget http://mirror.olnevhost.net/pub/apache/tomcat/tomcat-6/v6.0.26/bin/apache-tomcat-6.0.26.tar.gz
tar xf apache-tomcat*
cd apache-tomcat-6.0.26/

# Change the port numbers, so conflicts are less likely
sed -i "s/\<8080\>/$TOMCAT_HTTP_PORT/g" conf/server.xml
sed -i "s/\<8443\>/$TOMCAT_REDIRECT_PORT/g" conf/server.xml
sed -i "s/\<8005\>/$TOMCAT_SERVER_PORT/g" conf/server.xml

# Remove the default webapp
rm -rf webapps/ROOT

# Install our webapp
cp -v $DISCOVER_ED_ROOT/src/build/nutch*.war webapps/ROOT.war

# Start tomcat
bin/catalina.sh start

# FIXME: Detect whether a tomcat instance has started and complain if so.
# FIXME: Or use an exotic port number that's unlikely to conflict with an
# already-running tomcat instance.

echo "Waiting for Tomcat to start..."

WAIT=20
# Now, wait up to $WAIT seconds for Tomcat to start
if nc -w $WAIT -z localhost $TOMCAT_HTTP_PORT; then
	firefox "http://localhost:$TOMCAT_HTTP_PORT/search.jsp?query=crime"
else
	echo "Eek, Tomcat took more than $WAIT seconds to start. Try waiting a bit longer and visiting http://localhost:$TOMCAT_HTTP_PORT/search.jsp?query=crime in your web browser."
fi
